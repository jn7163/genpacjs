#! /usr/bin/env node
// -*- js -*-

const yargs = require('yargs');

const GenPAC = require('../src/genpac');
const packageInfo = require('../package.json');

const { argv } = yargs
    .usage('Usage: genpac [options]')
    .help('help')
    .alias('h', 'help')
    .version(packageInfo.version)
    .alias('v', 'version')
    .option('proxy', {
        alias: 'p',
        type: 'string',
        description: 'PAC文件中使用的代理信息',
    })
    .option('gfwlist-url', {
        type: 'string',
        default: 'https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt',
        description: 'gfwlist 地址，一般不需要更改',
    })
    .option('gfwlist-proxy', {
        type: 'string',
        description: '获取 gfwlist 时的代理设置，如果你可以正常访问 gfwlist，则无必要使用该选项',
    })
    .option('gfwlist-local', {
        type: 'string',
        description: '本地 gfwlist 文件地址，当在线地址获取失败时使用',
    })
    .option('gfwlist-local-ignore-overwrite', {
        type: 'boolean',
        default: false,
        description: '当在线 gfwlist 成功获取且 --gfwlist-local 存在时，默认会将在线内容覆盖到本地，此项设置后则不覆盖',
    })
    .option('user-rule', {
        type: 'array',
        description: '自定义规则，该选项允许重复使用',
    })
    .option('user-rule-from', {
        type: 'array',
        description: '从文件中读取自定义规则，该选项允许重复使用',
    })
    .option('config-from', {
        type: 'string',
        description: '从文件中读取配置信息',
    })
    .option('output', {
        type: 'string',
        description: '输出生成的文件，如果没有此选项，将直接打印结果',
    })
    .option('verbose', {
        default: false,
        type: 'boolean',
        description: '是否输出详细处理过程',
    });

const {
    proxy,
    'gfwlist-url': gfwlistURL,
    'gfwlist-proxy': gfwlistProxy,
    'gfwlist-local': gfwlistLocal,
    'gfwlist-local-ignore-overwrite': gfwlistLocalIgnoreOverwrite,
    'user-rule': userRule,
    'user-rule-from': userRuleFrom,
    'config-from': configFrom,
    output,
    verbose,
} = argv;

const genpac = new GenPAC({
    pacProxy: proxy,
    outputFile: output,
    gfwlistURL,
    gfwlistProxy,
    gfwlistLocal,
    gfwlistLocalIgnoreOverwrite,
    userRules: userRule,
    userRuleFiles: userRuleFrom,
    configFile: configFrom,
    verbose,
});

genpac.generate();
